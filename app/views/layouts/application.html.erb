<html>
  <head>
    <title>Magic: The Gathering</title>
    <script src="/javascripts/jquery-1.4.4.min.js"></script>
    <script src="/javascripts/application.js"></script>
    <%= stylesheet_link_tag "main" %>
    <%= render :partial => "layouts/analytics" %>
    <script type="text/javascript">
      Searcher = {
        maxScroll: 3000,
        currFormat: null,

        init: function() {
          $(document).keydown(Searcher.onKeyDown);
          $("#searchbox").focus(Searcher.onSearchFocus);
          $("#searchbox").blur(Searcher.onSearchBlur);
        },

        focusSearchbox: function(field, event) {
          if (event)
            event.preventDefault();
          $("#searchbox").focus();
          if (field != "") {
            $("#searchbox").val(field + ": ");
          } else {
            $("#searchbox").val("");
            $("#searchBreadcrumbs").html("")
            Searcher.newSearch();
          }
        },

        newSearch: function() {
          if ($("#searchbox.grayText").size() > 0) {
            console.log("returning");
            return;
          }
          Searcher.maxScroll = 3000;
          Searcher.search(0, true);
        },

        search: function(offset, newSearch, queryString) {
          query = $("#searchbox").val(); ;
          if (queryString) {
            query = queryString
          }

          //if we are not on the homepage, redirect there, less we
          //break things.  this is really hacky and should be fixed.
          if (window.location.pathname != "/" &&
              window.location.pathname.substr(0, 11) != "/deck/edit/") {
            if ($("#deckmetadata").length) {
              var deckHash = $("#deckmetadata").attr("deckhash");
              window.location.href= "/deck/edit/" + deckHash + "?search=" + query;
            }
          }

          $("#searchbox").blur();

          var queries = [];
          var breadcrumbs = $(".breadcrumb input");
          $.each(breadcrumbs, function(index, element) {
            queries.push([$(element).attr("name"), $(element).val()])
          });

          if (newSearch)
            $("#searchResults").html("");

          $.ajax({
              type: "POST",
              url: "/search/search",
              data: {
                query: query,
                queries: queries,
                offset: offset
              },
              success: function(html) {
                $("#searchResults").html(html);
                $("#searchResults .card").click(CardDisplay.onClickCard);
                CardDisplay.attachScrollListener();
                CardDisplay.handleCardMode();
              }
          });
        },

        onSearchFocus: function() {
          $("#searchbox").val("");
          $("#searchbox").removeClass("grayText");
        },

        onSearchBlur: function() {
          if ($("#searchbox").val() != "")
            return;

          $("#searchbox").addClass("grayText");
          $("#searchbox").val('type "/" to search');
        },

        onKeyDown: function(event) {
          if ($("*:focus").size() > 0 && event.which != 13)
            return;


          //console.log("keypress: " + event.which);

          switch (event.which) {
            case 13: Searcher.newSearch(); break; // return
            case 191: Searcher.focusSearchbox("", event); break; // /
            case 78: Searcher.focusSearchbox("name", event); break; // n
            case 84: Searcher.focusSearchbox("text", event); break; // t
            case 77: Searcher.focusSearchbox("mana", event); break; // m
            case 67: Searcher.focusSearchbox("color", event); break; // c
            case 89: Searcher.focusSearchbox("type", event); break; // y
            case 83: Searcher.focusSearchbox("set", event); break; // s
            case 188: Searcher.focusSearchbox("power", event); break; // ,
            case 190: Searcher.focusSearchbox("toughness", event); break; // .
          }
        },
      }

      $(document).ready(Searcher.init);

    </script>
  </head>
  <body>
    <div id="main">
      <div id="pageBox">
  <div id="searchSection">
    <div id="header">
      <div id="searchboxDiv"> 
	<input id="searchField" type="hidden" value="name" />
	<input id="searchbox" class="grayText" value='type "/" to search' type="text" />
      </div>
    </div>
    <!--<div id="searchInstructions">
      <table>
        <tr>
          <div id="formatRow">
            <%
            @format = ((session[:format]) ? session[:format] : 'all')
            [ 'all', 'extended', 'standard', 'block'].each do |format| %>
              <%= radio_button_tag 'format', format, @format == format, {
                :onclick => "Searcher.setFormat('" + format + "');"
                } %>
              <%= label_tag "format_#{format}", format.humanize %>
            <% end %>
            <div id='sortByBox'>
              <label>Sort By:  </label>
              <%=
              option_string = ""
              sort_options = ['Name', 'Color', 'Mana Cost', 'Type',
                              'Set', 'Power', 'Toughness']
              sort_options.each do |option|
                option_string = option_string + "<option" +
                  ((session[:sort] == option.split.first.downcase) ? " selected='selected'>" : ">")
                option_string = option_string + option + "</option>"
              end
              select_tag 'sort',
                option_string,
                {:onchange => "Searcher.sortGrid(" +
                              "this.options[this.selectedIndex].value" +
                              ");"}
              %>
            <div>
          </div>
        </tr>
        <tr>
          <td><span class="hotkey">/</span>: restart search</td>
          <td><span class="hotkey">n</span>: search card name (name:)</td>
          <td><span class="hotkey">t</span>: search card text (text:)</td>
        </tr>
        <tr>
          <td><span class="hotkey">m</span>: search converted mana cost (mana:)</td>
          <td><span class="hotkey">c</span>: search by mana color (color:)</td>
          <td><span class="hotkey">y</span>: search by card type (type:)</td>
        </tr>
        <tr>
          <td><span class="hotkey">s</span>: search by set (set:)</td>
          <td><span class="hotkey bold">,</span>: search by power (power:)</td>
          <td><span class="hotkey bold">.</span>: search by toughness (toughness:)</td>
        </tr>
        <tr>
          <td><span class="hotkey bold">x</span>: toggle keyboard card selection</td>
        </tr>
      </table>
    </div>
      -->
    
      <%= render :partial => "layouts/login" %>
      <%= yield %>
    
    </div>
    <%= render :partial => "/search/deckmetadata", :locals => {:deck => @deck,
      :viewing_deck => false} %>
    </div>
    </div>
  </body>
</html>

